// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  DRAFT
  PENDING
  PAID
  FULFILLED
  CANCELED
  REFUNDED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  ownerName     String
  petName       String
  image         String?      // profile photo URL
  passwordHash  String
  emailVerified DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // one profile page per user
  page Page?

  orders  Order[]
  sessions Session[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
}

model Product {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String
  imageUrl    String
  currency    String   @default("usd")
  unitAmount  Int      // cents
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems OrderItem[]
}

model Order {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  status        OrderStatus @default(DRAFT)
  currency      String      @default("usd")
  totalCents    Int         @default(0)
  provider      String      // your gateway name/code
  providerRef   String?     // session/intent/transaction id from provider
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  items         OrderItem[]
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    Product @relation(fields: [productId], references: [id])
  quantity   Int
  unitCents  Int
  nameSnap   String  // snapshot name at purchase time
}

model Page {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  slug       String   @unique   // public URL slug, default to username
  displayName String             // show pet name prominently
  bioHtml    String?             // sanitized bio HTML
  profileUrl String?             // avatar URL
  themeJson  Json?               // colors/fonts/options
  socialsJson Json?              // map: {twitter, instagram, tiktok, youtube, ...}
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  links   Link[]
  embeds  Embed[]
  files   FileAsset[]
}

model Link {
  id        String  @id @default(cuid())
  pageId    String
  page      Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  title     String
  url       String
  position  Int
  clicks    Int     @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, position])
}

model Embed {
  id        String  @id @default(cuid())
  pageId    String
  page      Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  provider  String  // e.g. youtube, vimeo, twitter, etc.
  srcUrl    String
  htmlSafe  String  // sanitized iframe or provider html
  position  Int
  createdAt DateTime @default(now())

  @@index([pageId, position])
}

model FileAsset {
  id          String  @id @default(cuid())
  pageId      String
  page        Page    @relation(fields: [pageId], references: [id], onDelete: Cascade)
  name        String
  blobUrl     String  // public URL from Vercel Blob
  sizeBytes   Int
  contentType String
  position    Int
  createdAt   DateTime @default(now())
  @@index([pageId, position])
}

